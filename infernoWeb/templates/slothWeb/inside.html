{% extends "infernoWeb/inside.html" %}
{% load static %}
{% block insideStyleSheet %}
    <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
    <link rel="stylesheet" href="https://rawgit.com/tpreusse/radar-chart-d3/master/src/radar-chart.css">
    <link rel="stylesheet" href={% static "bower_components/semantic/dist/semantic.min.css" %}>
    <style>
    .radar-chart .area {
    fill-opacity: 0.7;
    }
    .radar-chart.focus .area {
    fill-opacity: 0.3;
    }
    .radar-chart.focus .area.focused {
    fill-opacity: 0.9;
    }
    .area.germany, .germany .circle {
    fill: #FFD700;
    stroke: none;
    }
    .area.argentina, .argentina .circle {
    fill: #ADD8E6;
    stroke: none;
    }
    </style>
{% endblock %}
{% block profile %}
    <div class="item">
        <img src="{{ c.avatar.url }}">
        <div class="content">
            <h3>{{ c.name }}</h3>
            <div class="meta">
                <p class="cinema">老師：{{ c.teacher }}</p>
            </div>
            <div class="description">
                <p>課程類型：{{ c.ctype }}</p>
                <p>上課用書：{{ c.book }}</p>
                <p>課程大綱：{{ c.syllabus }}</p>
            </div>
            <div class="extra">
                <div class="ui labeled button" tabindex="0">
                    <i class="fa fa-star" aria-hidden="true"></i>{{ c.feedback_amount}}人參與評分
                </div>
            </div>
            <div class="chart-container"></div>
        </div>
    </div>

    {% include "slothWeb/questionnaire.html" %}
    <div class="order"><button class="orderBtn">參與評比該課程</button></div>
{% endblock %}
{% block comments %}
    {# 列出所有使用者的留言 #}
    {% for i in comments %}
        <div class="customer">
            <img src="http://semantic-ui.com/images/avatar/small/matt.jpg">
        </div>
        <div class="cusInfo">
            <b>{{i.author}}</b>　<i>{{i.create}}</i>
            <div class="text">
                <p>{{i.raw}}</p>
                <div class="ui labeled button" tabindex="0">
                  <div class="ui red button">
                    <i class="heart icon"></i> Like
                  </div>
                  <a class="ui basic red left pointing label">
                    1,048
                  </a>
                </div>
            </div>
        </div>
    {% endfor %}
{% endblock %}
{% block insideJavascript %}
    <script src={% static "bower_components/d3/d3.min.js" %}></script>
    <script src={% static "bower_components/radar-chart-d3/src/radar-chart.min.js" %}></script>
    <script src={% static "bower_components/semantic/dist/semantic.min.js" %}></script>

    <script>
    /*************************************************************************/
    // 給django做post的時候用來取得csrftoken的函式
    function getCookie(name) {
            //name should be 'csrftoken', as an argument to be sent into getCookie()
           var cookieValue = null;
           if (document.cookie && document.cookie != '') {
               var cookies = document.cookie.split(';');
               for (var i = 0; i < cookies.length; i++) {
                   var cookie = jQuery.trim(cookies[i]);
                   // Does this cookie string begin with the name we want?
                   if (cookie.substring(0, name.length + 1) == (name + '=')) {
                       cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                       break;
                   }
               }
           }
           return cookieValue;
    }
    function getcrsftoken(){
        return getCookie('csrftoken');//呼叫getCookie函數來取得csfttoken
    }
    /*************************************************************************/

    $( document ).ready(function() {
        /************************畫雷達圖***************************/
        async function run(){
          function getArticleList(){
              id = location.search.split('id=')[1]
              return new Promise(function(resolve, reject){
                  $.getJSON( "/sloth/get/cvalue?id="+id, function( j ) {
                  }).done(result => {
                      resolve(result);
                  });
              });
          }
          var result = await getArticleList();
          data = [
            {
                axes: [
                {axis: "自由", value: result['feedback_freedom']},
                {axis: "知識性", value: result['feedback_knowledgeable']},
                {axis: "氛圍", value: result['feedback_FU']},
                {axis: "成績", value: result['feedback_GPA']},
                {axis: "簡單", value: result['feedback_easy']}
                ]
            },
            {
                axes: [
                {axis: "自由", value: 5},
                {axis: "知識性", value: 5},
                {axis: "氛圍", value: 5},
                {axis: "成績", value: 5},
                {axis: "簡單", value: 5}
                ]
            } 
          ]

          $('.chart-container').empty();
          var chart = RadarChart.chart();
          var svg = d3.select('.chart-container').append('svg')
            .attr('width', 600)
            .attr('height', 600); 

          // draw one
          svg = svg.append('g').classed('focus', 3).datum(data)
          svg.call(chart)
          d3.selectAll(".axis text").style("font-size","25px")
          d3.select('polygon.radar-chart-serie1').style('visibility','hidden');
        }
        run();
        /************************畫雷達圖***************************/

        // semantic-ui activation function
        $('.rating').rating('setting', 'clearable', true);
        $('.orderBtn').click(function(){
            $('.modal')
              .modal('show')
            ;            
        })

        // 提交心得表單
        $('#questionnaire').click(function() {
            // 取得semantic-ui的星星評分的value
            let value = $('.ui.rating')
              .rating('get rating').map(Number);
            let postdata = {
                'csrfmiddlewaretoken':getCookie('csrftoken'),
                'rating':JSON.stringify(value),
            }
            // pathname + search 就等於url pattern + querystring            
            $.post( window.location.pathname + window.location.search, postdata)
            .done(function() {
                toastr.success('問卷提交成功')
                run();
            })
            .fail(function() {
                toastr.error('問卷提交失敗')
            })
            .always(function() {
                console.log( "finished" );
            });               
       });
    });

    </script>
{% endblock %}